version: 2

references:
  container_config: &container_config
    docker:
      - image: openjdk:8-jdk

jobs:
  build:
    <<: *container_config
    steps:
      - checkout
      - run:
          name: install dependencies
          command: |
            apt-get update -y && apt-get install -y build-essential maven
      - run:
          name: build package
          command: |
            make clean
            make package
            make test-command
  test:
    <<: *container_config
    steps:
      - checkout
      - run:
          name: install dependencies
          command: |
            apt-get update -y && apt-get install -y build-essential maven
      - run:
          name: run unit tests
          command: |
            make clean
            make checkstyle
            make test
  push:
    <<: *container_config
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: push a docker image
          command: |
            echo "$DOCKERHUB_USER"

workflows:
  version: 2
  build_test_push:
    jobs:
      - test
      - build:
          requires:
            - test
      - push:
          requires:
            - build
          filters:
            tags:
              only: /[0-9]+(\.[0-9]+)*/
            branches:
              ignore: /.*/
